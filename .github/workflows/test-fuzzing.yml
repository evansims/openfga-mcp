name: "Testing: Fuzzing"

on:
  schedule:
    # Run fuzzing every night at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      duration:
        description: "Fuzzing duration in seconds"
        required: false
        default: "300"
        type: string
  pull_request:
    paths:
      - "src/**"
      - "tests/Fuzzing/**"
      - ".github/workflows/test-fuzzing.yml"

permissions:
  contents: read

jobs:
  fuzz:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      security-events: write # For uploading results to security tab

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup PHP
        uses: shivammathur/setup-php@bf6b4fbd49ca58e4608c9c89fba0b8d90bd2a39f # 2.35.5
        with:
          php-version: "8.3"
          extensions: mbstring, intl
          coverage: none
          tools: composer:v2

      - name: Install dependencies
        run: |
          composer require --dev nikic/php-fuzzer
          composer install --prefer-dist --no-progress

      - name: Create fuzzing corpus directory
        run: mkdir -p tests/Fuzzing/corpus

      - name: Download existing corpus
        continue-on-error: true
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: fuzzing-corpus
          path: tests/Fuzzing/corpus

      - name: Run fuzzing tests
        env:
          FUZZING_DURATION: ${{ github.event.inputs.duration || '300' }}
        run: |
          # Set memory limit for fuzzing
          export ASAN_OPTIONS=allocator_may_return_null=1

          # Run fuzzing with timeout
          timeout "${FUZZING_DURATION}s" php tests/Fuzzing/run-fuzzers.php || EXIT_CODE=$?

          # Exit code 124 means timeout (expected), anything else is a real error
          if [ "${EXIT_CODE:-0}" -ne 0 ] && [ "${EXIT_CODE:-0}" -ne 124 ]; then
            echo "Fuzzing failed with exit code: ${EXIT_CODE}"
            exit "${EXIT_CODE}"
          fi

      - name: Upload crash artifacts
        if: failure()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: fuzzing-crashes-${{ github.run_id }}
          path: tests/Fuzzing/crashes/
          retention-days: 30

      - name: Upload updated corpus
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: fuzzing-corpus
          path: tests/Fuzzing/corpus/
          retention-days: 7

      - name: Generate SARIF report
        if: failure()
        run: |
          php tests/Fuzzing/generate-sarif.php > fuzzing-results.sarif

      - name: Upload SARIF results
        if: failure()
        uses: github/codeql-action/upload-sarif@4e94bd11f71e507f7f87df81788dff88d1dacbfb # v4.31.0
        with:
          sarif_file: fuzzing-results.sarif
          category: fuzzing
